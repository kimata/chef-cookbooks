# Generated by Chef for <%= node['fqdn'] %>

modprobe ip_conntrack_ftp
modprobe nf_conntrack nf_conntrack_helper=0

###############################################################################
# SETTING
LOG="on"

SSH_PORT="1022"
LOP_IFACE="lo"
WAN_IFACE="eth0"
LAN_IFACE="eth1"
LAN_IP_RANGE="192.168.2.0/24"

COLUMBIA_IP="192.168.2.1"
BRAZIL_IP="192.168.2.30"

run_iptables -N FROM_WAN
run_iptables -N FROM_LAN
run_iptables -N TO_WAN
run_iptables -N TO_LAN
run_iptables -N WAN2LAN
run_iptables -N LAN2WAN

###############################################################################
# ATTACK [TCP]
run_iptables -N TCP_CHECK
run_iptables -N BAD_TCP
if [ x$LOG = xon ]; then
    run_iptables -A BAD_TCP -m limit --limit 1/second --limit-burst 5 -j ULOG --ulog-prefix "iptables DIED(BAD_TCP): "
fi
run_iptables -A BAD_TCP -p tcp -j REJECT --reject-with tcp-reset
run_iptables -A TCP_CHECK -p tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW                -j BAD_TCP
run_iptables -A TCP_CHECK -p tcp --tcp-flags RST RST -m state --state NEW                        -j BAD_TCP
run_iptables -A TCP_CHECK -p tcp --tcp-flags ACK ACK -m state --state NEW                        -j BAD_TCP

###############################################################################
# SSH
run_iptables -N SSH
run_iptables -N SSH_ATTACK
run_iptables -A SSH_ATTACK -m limit --limit 3/minute --limit-burst 3 -j ULOG --ulog-prefix "iptables DIED(SSH_ATTACK): "
run_iptables -A SSH_ATTACK -m recent --name SSH_ATTACK --set
## run_iptables -A SSH -p tcp --syn -m recent --name SSH_ATTACK --rcheck --seconds 864000           -j DROP
run_iptables -A SSH -p tcp --syn -m recent --name SSH_CONN --rcheck --seconds 60 --hitcount 3    -j SSH_ATTACK
run_iptables -A SSH -p tcp --syn -m recent --name SSH_CONN --set                                 -j ACCEPT
run_iptables -A SSH -p tcp -m state --state NEW,ESTABLISHED,RELATED                              -j ACCEPT   # SSH

###############################################################################
# ALL [ICMP]
run_iptables -A TO_WAN   -p icmp --icmp-type time-exceeded                                       -j ACCEPT
run_iptables -A TO_WAN   -p icmp --icmp-type echo-request                                        -j ACCEPT
run_iptables -A TO_WAN   -p icmp --icmp-type destination-unreachable                             -j ACCEPT

run_iptables -A FROM_WAN -p icmp --icmp-type time-exceeded                                       -j ACCEPT
run_iptables -A FROM_WAN -p icmp --icmp-type echo-reply                                          -j ACCEPT
run_iptables -A FROM_WAN -p icmp --icmp-type destination-unreachable                             -j ACCEPT

run_iptables -A WAN2LAN  -p icmp --icmp-type destination-unreachable                             -j ACCEPT

run_iptables -A TO_LAN   -p icmp -s ${COLUMBIA_IP}                                               -j ACCEPT
run_iptables -A FROM_LAN -p icmp -d ${COLUMBIA_IP}                                               -j ACCEPT
run_iptables -A TO_LAN   -p icmp --icmp-type echo-request                                        -j ACCEPT
run_iptables -A FROM_LAN -p icmp --icmp-type echo-reply                                          -j ACCEPT

run_iptables -A TO_WAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport 33434:33690     -j ACCEPT   # TRACEROUTE

###############################################################################
# WAN -> ROUTER [TCP,UDP]
run_iptables -A FROM_WAN -p tcp -m state --state ESTABLISHED,RELATED     --dport ${SSH_PORT}     -j ACCEPT   # SSH
run_iptables -A FROM_WAN -p tcp -m state --state NEW                     --dport ${SSH_PORT}     -j SSH      # SSH
run_iptables -A FROM_WAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport http            -j ACCEPT   # HTTP
run_iptables -A FROM_WAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport https           -j ACCEPT   # HTTP
run_iptables -A FROM_WAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --sport http            -j ACCEPT   # HTTP
run_iptables -A FROM_WAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport smtp            -j ACCEPT   # SMTP
run_iptables -A FROM_WAN -p udp -m state --state NEW,ESTABLISHED,RELATED --dport bootpc          -j ACCEPT   # DHCP
run_iptables -A FROM_WAN -p udp -m state --state NEW,ESTABLISHED,RELATED --dport bootps          -j ACCEPT   # DHCP

run_iptables -A FROM_WAN -p igmp                                                                 -j ACCEPT   # IGMP

## run_iptables -A FROM_WAN -p udp                                          --dport 1900            -j DROP     # UPnP

## run_iptables -A FROM_WAN -d ${LAN_IP_RANGE}                                                      -j DROP

run_iptables -A FROM_WAN -p tcp -m state --state ESTABLISHED,RELATED                             -j ACCEPT
run_iptables -A FROM_WAN -p udp -m state --state ESTABLISHED,RELATED                             -j ACCEPT

if [ x$LOG = xon ]; then
    run_iptables -A FROM_WAN -m limit --limit 3/minute --limit-burst 3 -j ULOG --ulog-prefix "iptables DIED(FROM_WAN): "
fi

###############################################################################
# ROUTER -> WAN [TCP,UDP]
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport ssh             -j ACCEPT   # SSH
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport pop3            -j ACCEPT   # POP3
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport http            -j ACCEPT   # HTTP
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport https           -j ACCEPT   # HTTP
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport smtp            -j ACCEPT   # SMTP
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport submission      -j ACCEPT   # SMTP
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport rsync           -j ACCEPT   # RSYNC
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport cvspserver      -j ACCEPT   # CVS
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport svn             -j ACCEPT   # SVN
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport ftp             -j ACCEPT   # FTP
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport ftp-data        -j ACCEPT   # FTP
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport domain          -j ACCEPT   # DNS
run_iptables -A TO_WAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport bootpc          -j ACCEPT   # DHCP
run_iptables -A TO_WAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport bootps          -j ACCEPT   # DHCP
run_iptables -A TO_WAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport domain          -j ACCEPT   # DNS
run_iptables -A TO_WAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport ntp             -j ACCEPT   # NTP
run_iptables -A TO_WAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport 9418            -j ACCEPT   # Git

run_iptables -A TO_WAN   -p igmp                                                                 -j ACCEPT   # IGMP

## run_iptables -A TO_WAN   -p udp                                          --sport 1900            -j DROP     # SQUEEZE BOX
## run_iptables -A TO_WAN   -p udp                                          --dport 3483            -j DROP     # SQUEEZE BOX

run_iptables -A TO_WAN   -p tcp -m state --state ESTABLISHED,RELATED                             -j ACCEPT
run_iptables -A TO_WAN   -p udp -m state --state ESTABLISHED,RELATED                             -j ACCEPT

if [ x$LOG = xon ]; then
    run_iptables -A TO_WAN -m limit --limit 3/minute --limit-burst 3 -j ULOG --ulog-prefix "iptables DIED(TO_WAN  ): "
fi

###############################################################################
# LAN -> ROUTER [TCP,UDP]
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport ${SSH_PORT}     -j ACCEPT   # SSH
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport imap            -j ACCEPT   # IMAP
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport smtp            -j ACCEPT   # SMTP
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport http            -j ACCEPT   # HTTP
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport https           -j ACCEPT   # HTTP
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport ndtp            -j ACCEPT   # NDTP
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport mysql           -j ACCEPT   # MYSQL
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport svn             -j ACCEPT   # SVN
run_iptables -A FROM_LAN -p udp -m state --state NEW,ESTABLISHED,RELATED --dport domain          -j ACCEPT   # DNS
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport domain          -j ACCEPT   # DNS
run_iptables -A FROM_LAN -p udp -m state --state NEW,ESTABLISHED,RELATED --dport ntp             -j ACCEPT   # NTP
run_iptables -A FROM_LAN -p udp -m state --state NEW,ESTABLISHED,RELATED --dport bootpc          -j ACCEPT   # DHCP
run_iptables -A FROM_LAN -p udp -m state --state NEW,ESTABLISHED,RELATED --dport bootps          -j ACCEPT   # DHCP
run_iptables -A FROM_LAN -p udp -m state --state NEW,ESTABLISHED,RELATED --dport loc-srv         -j ACCEPT   # SAMBA
run_iptables -A FROM_LAN -p udp -m state --state NEW,ESTABLISHED,RELATED --dport netbios-ns      -j ACCEPT   # SAMBA
run_iptables -A FROM_LAN -p udp -m state --state NEW,ESTABLISHED,RELATED --dport netbios-dgm     -j ACCEPT   # SAMBA
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport netbios-ssn     -j ACCEPT   # SAMBA
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport microsoft-ds    -j ACCEPT   # SAMBA
run_iptables -A FROM_LAN -p udp -m state --state NEW,ESTABLISHED,RELATED --dport snmp            -j ACCEPT   # SNMP
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport 3551            -j ACCEPT   # APCUPS

run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport 12865           -j ACCEPT   # Netperf
run_iptables -A FROM_LAN -p udp                                          --dport 12865           -j ACCEPT   # Netperf

run_iptables -A FROM_LAN -p udp                                          --dport 1900            -j ACCEPT   # UPnP
run_iptables -A FROM_LAN -p udp                                          --dport 9090            -j ACCEPT   # WeMo

run_iptables -A FROM_LAN -p udp                                          --dport 17784           -j ACCEPT   # SQUEEZE BOX
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport 3483            -j ACCEPT   # SQUEEZE BOX
run_iptables -A FROM_LAN -p udp                                          --dport 3483            -j ACCEPT   # SQUEEZE BOX
run_iptables -A FROM_LAN -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport 9000            -j ACCEPT   # SQUEEZE BOX


## run_iptables -A FROM_LAN -p udp                                          --sport 4114            -j DROP     # OMRON UPS

run_iptables -A FROM_LAN -p tcp -m state --state ESTABLISHED,RELATED                             -j ACCEPT
run_iptables -A FROM_LAN -p udp -m state --state ESTABLISHED,RELATED                             -j ACCEPT

if [ x$LOG = xon ]; then
    run_iptables -A FROM_LAN -m limit --limit 3/minute --limit-burst 3 -j ULOG --ulog-prefix "iptables DIED(FROM_LAN): "
fi

###############################################################################
# ROUTER -> LAN [TCP,UDP]
run_iptables -A TO_LAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport http            -j ACCEPT   # HTTP
run_iptables -A TO_LAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport ssh             -j ACCEPT   # SSH
run_iptables -A TO_LAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport bootpc          -j ACCEPT   # DHCP
run_iptables -A TO_LAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport bootps          -j ACCEPT   # DHCP
run_iptables -A TO_LAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport netbios-ns      -j ACCEPT   # SAMBA
run_iptables -A TO_LAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport netbios-dgm     -j ACCEPT   # SAMBA
run_iptables -A TO_LAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport netbios-ssn     -j ACCEPT   # SAMBA
run_iptables -A TO_LAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport microsoft-ds    -j ACCEPT   # SAMBA
run_iptables -A TO_LAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport snmp            -j ACCEPT   # SNMP
run_iptables -A TO_LAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport 12865           -j ACCEPT   # Netperf
run_iptables -A TO_LAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport 12865           -j ACCEPT   # Netperf

run_iptables -A TO_LAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --sport 9090            -j ACCEPT   # WeMo
run_iptables -A TO_LAN   -p tcp -m state --state NEW,ESTABLISHED,RELATED -s ${COLUMBIA_IP}       -j ACCEPT   # WeMo

run_iptables -A TO_LAN   -p udp                                          --sport 1900            -j ACCEPT   # SQUEEZE BOX
run_iptables -A TO_LAN   -p udp                                          --sport 3483            -j ACCEPT   # SQUEEZE BOX

run_iptables -A TO_LAN   -p udp -m state --state NEW,ESTABLISHED,RELATED --dport 9               -j ACCEPT   # WOL

run_iptables -A TO_LAN   -p tcp -m state --state ESTABLISHED,RELATED                             -j ACCEPT
run_iptables -A TO_LAN   -p udp -m state --state ESTABLISHED,RELATED                             -j ACCEPT

if [ x$LOG = xon ]; then
    run_iptables -A TO_LAN -m limit --limit 3/minute --limit-burst 3 -j ULOG --ulog-prefix "iptables DIED(TO_LAN  ): "
fi

###############################################################################
# WAN -> LAN [TCP,UDP]
run_iptables -A WAN2LAN  -p tcp -m state --state NEW,ESTABLISHED,RELATED --sport http            -j ACCEPT   # HTTP
run_iptables -A WAN2LAN  -p tcp -m state --state NEW,ESTABLISHED,RELATED --sport https           -j ACCEPT   # HTTP
run_iptables -A WAN2LAN  -p tcp -m state --state NEW,ESTABLISHED,RELATED --sport 843             -j ACCEPT   # Adobe Flash
run_iptables -A WAN2LAN  -p tcp -m state --state NEW,ESTABLISHED,RELATED --sport 5223            -j ACCEPT   # Apple Push Notification Service
run_iptables -A WAN2LAN  -p tcp -m state --state NEW,ESTABLISHED,RELATED --sport 9000            -j ACCEPT   # SQUEEZE BOX
run_iptables -A WAN2LAN  -p tcp -m state --state NEW,ESTABLISHED,RELATED --sport 5228            -j ACCEPT   # Google Play

## run_iptables -A WAN2LAN  -p tcp                                      --sport 5222                -j DROP     # Google Talk
## run_iptables -A WAN2LAN  -p tcp                                      --sport 2533                -j DROP     # Sniffer Server 

if [ x$LOG = xon ]; then
    run_iptables -A WAN2LAN -m limit --limit 3/minute --limit-burst 3 -j ULOG --ulog-prefix "iptables DIED(WAN2LAN ): "
fi

###############################################################################
# LAN -> WAN [TCP,UDP]
run_iptables -A LAN2WAN  -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport http            -j ACCEPT   # HTTP
run_iptables -A LAN2WAN  -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport https           -j ACCEPT   # HTTP
run_iptables -A LAN2WAN  -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport 9000            -j ACCEPT   # SQUEEZE BOX
run_iptables -A LAN2WAN  -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport 5223            -j ACCEPT   # Apple Push Notification Service
run_iptables -A LAN2WAN  -p tcp -m state --state NEW,ESTABLISHED,RELATED --dport 843             -j ACCEPT   # Adobe Flash

## run_iptables -A LAN2WAN  -p tcp                                          --dport 5222            -j DROP     # Google Talk
## run_iptables -A LAN2WAN  -p udp                                          --dport snmp            -j DROP     # SNMP
## run_iptables -A LAN2WAN  -p udp                                          --dport 3544            -j DROP     # Teredo

## run_iptables -A LAN2WAN  -p tcp                                          --dport http            -j DROP     # HTTP (othe state)

if [ x$LOG = xon ]; then
   run_iptables -A LAN2WAN  -p tcp -m state --state INVALID           -j ULOG --ulog-prefix "iptables INVALID(LAN2WAN ): "
fi

run_iptables -A LAN2WAN  -p tcp -m state --state ESTABLISHED,RELATED                             -j ACCEPT
run_iptables -A LAN2WAN  -p udp -m state --state ESTABLISHED,RELATED                             -j ACCEPT

if [ x$LOG = xon ]; then
    run_iptables -A LAN2WAN -m limit --limit 3/minute --limit-burst 3 -j ULOG --ulog-prefix "iptables DIED(LAN2WAN ): "
fi

###############################################################################
# NAT
#run_iptables -t nat -A PREROUTING -i ${WAN_IFACE} -p tcp --dport http    -j DNAT --to-destination ${COLUMBIA_IP}
#run_iptables -t nat -A PREROUTING -i ${WAN_IFACE} -p tcp --dport https   -j DNAT --to-destination ${COLUMBIA_IP}
#run_iptables -t nat -A PREROUTING -i ${WAN_IFACE} -p udp --dport domain  -j DNAT --to-destination ${BRAZIL_IP}

run_iptables -t nat -A POSTROUTING -s ${LAN_IP_RANGE} -o ${WAN_IFACE}                            -j MASQUERADE

###############################################################################
# ALL [TCP]
run_iptables -A INPUT    -i ${LAN_IFACE}                                                         -j TCP_CHECK
run_iptables -A OUTPUT   -o ${LAN_IFACE}                                                         -j TCP_CHECK

run_iptables -A INPUT    -i ${WAN_IFACE}                                                         -j TCP_CHECK
run_iptables -A OUTPUT   -o ${WAN_IFACE}                                                         -j TCP_CHECK

###############################################################################
# INTERFACE
run_iptables -A FORWARD  -i ${WAN_IFACE} -o ${LAN_IFACE}                                         -j WAN2LAN
run_iptables -A FORWARD  -i ${LAN_IFACE} -o ${WAN_IFACE}                                         -j LAN2WAN
run_iptables -A FORWARD  -i ${LAN_IFACE} -s ${LAN_IP_RANGE}                                      -j ACCEPT
run_iptables -A FORWARD  -i ${WAN_IFACE} -d ${LAN_IP_RANGE}                                      -j ACCEPT

run_iptables -A INPUT    -i ${LAN_IFACE}                                                         -j FROM_LAN
run_iptables -A OUTPUT   -o ${LAN_IFACE}                                                         -j TO_LAN

run_iptables -A INPUT    -i ${WAN_IFACE}                                                         -j FROM_WAN
run_iptables -A OUTPUT   -o ${WAN_IFACE}                                                         -j TO_WAN

run_iptables -A INPUT    -i ${LOP_IFACE}                                                         -j ACCEPT
run_iptables -A OUTPUT   -o ${LOP_IFACE}                                                         -j ACCEPT

if [ x$LOG = xon ]; then
    run_iptables -A FORWARD -m limit --limit 3/minute --limit-burst 3 -j ULOG --ulog-prefix "iptables DIED(FORWARD): "
fi

###############################################################################
# echo "Press Ctrl+C, if you really want to set this rule."
# sleep 10
# iptables -P INPUT ACCEPT
# iptables -P OUTPUT ACCEPT
# iptables -P FORWARD ACCEPT
# iptables -X
# iptables -F
